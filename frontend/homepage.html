<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Homepage | WebNovel Nexus</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-md sticky-top border-bottom shadow-sm bg-body">
  <div class="container-xl">
    <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="homepage.html">
      <span class="bg-primary text-white rounded-2 p-1 d-inline-flex align-items-center">
        <span class="material-symbols-outlined" style="font-size:20px">book_4</span>
      </span>
      WebNovel Nexus
    </a>
    <button class="navbar-toggler" type="button"
      data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto gap-md-1 mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" href="index.html">
            <span class="material-symbols-outlined align-middle" style="font-size:16px">explore</span>
            Discover
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="add.html">
            <span class="material-symbols-outlined align-middle" style="font-size:16px">add_circle</span>
            Add Novel
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="booklist.html">
            <span class="material-symbols-outlined align-middle" style="font-size:16px">bookmarks</span>
            My Booklist
          </a>
        </li>
      </ul>
      <div class="d-flex gap-2 align-items-center mt-2 mt-md-0">
        <button class="btn btn-sm btn-outline-secondary" id="themeToggle" title="Toggle theme">
          <span class="material-symbols-outlined align-middle" style="font-size:18px" id="themeIcon">dark_mode</span>
        </button>
        <button class="btn btn-sm btn-outline-secondary">
          <span class="material-symbols-outlined align-middle" style="font-size:18px">notifications</span>
        </button>
        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
          <span class="material-symbols-outlined align-middle" style="font-size:18px">account_circle</span>
          My Profile
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- HERO -->
<div class="bg-primary text-white py-5">
  <div class="container-xl text-center">
    <h1 class="fw-bold display-5 mb-2">Rank</h1>
    <p class="mb-0 opacity-75">Top 5 most-read novels in each category</p>
  </div>
</div>

<!-- MAIN -->
<main class="container-xl py-5">
  <div class="row g-4" id="chartsGrid">
    <div class="col-12 text-center py-5 text-muted" id="loadingState">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3 mb-0">Loading chartsâ€¦</p>
    </div>
  </div>

  <div class="text-center py-5 d-none" id="globalError">
    <span class="material-symbols-outlined d-block mb-2 text-muted" style="font-size:48px">error</span>
    <h5 class="fw-bold">Failed to load charts</h5>
    <p class="text-muted">Please check your connection or server status.</p>
    <button onclick="loadCharts()" class="btn btn-primary btn-sm">Retry</button>
  </div>
</main>

<!-- FOOTER -->
<footer class="border-top bg-body-tertiary mt-5 py-4">
  <div class="container-xl text-center">
    <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
      <span class="bg-primary bg-opacity-25 text-primary rounded p-1 d-inline-flex">
        <span class="material-symbols-outlined" style="font-size:18px">book_4</span>
      </span>
      <span class="fw-bold">WebNovel Nexus</span>
    </div>
    <p class="text-muted small mb-3">Explore thousands of worlds, one chapter at a time.</p>
    <p class="text-muted" style="font-size:.75rem">Created by Danyan Gu and Xing Zhou</p>
  </div>
</footer>

<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE = '/api';

document.addEventListener('DOMContentLoaded', () => {
  restoreTheme();
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  loadCharts();
});

async function loadCharts() {
  document.getElementById('globalError').classList.add('d-none');
  document.getElementById('loadingState').classList.remove('d-none');

  try {
    const res = await fetch(`${API_BASE}/novels?limit=1000&page=1`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const novels = data.novels || [];

    const genreMap = {};
    novels.forEach(n => {
      const g = (n.genre || 'Unknown').trim();
      if (!genreMap[g]) genreMap[g] = [];
      genreMap[g].push(n);
    });

    const genreList = Object.entries(genreMap)
      .map(([genre, list]) => {
        const sorted = list.sort((a, b) => (b.read || 0) - (a.read || 0));
        const totalReads = sorted.reduce((s, n) => s + (n.read || 0), 0);
        return { genre, books: sorted.slice(0, 5), totalReads };
      })
      .sort((a, b) => b.totalReads - a.totalReads)
      .slice(0, 10);

    document.getElementById('loadingState').classList.add('d-none');

    if (genreList.length === 0) {
      document.getElementById('chartsGrid').innerHTML = `
        <div class="col-12 text-center py-5 text-muted">
          <span class="material-symbols-outlined d-block mb-2" style="font-size:48px">library_books</span>
          <h6 class="fw-bold">No novels found</h6>
          <small>Add some novels first to see genre charts.</small>
        </div>`;
      return;
    }

    renderCharts(genreList);
  } catch (err) {
    console.error(err);
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('globalError').classList.remove('d-none');
  }
}

function renderCharts(genreList) {
  const grid = document.getElementById('chartsGrid');
  grid.innerHTML = '';

  genreList.forEach(({ genre, books }) => {
    const rankBadges = ['bg-warning text-dark', 'bg-secondary text-white', 'bg-danger text-white'];

    const booksHtml = books.length === 0
      ? `<p class="text-muted small text-center py-3 mb-0">No novels yet</p>`
      : books.map((novel, rank) => {
          const badgeCls = rankBadges[rank] || 'bg-light text-dark';
          return `
            <div class="d-flex align-items-center gap-3 p-2 rounded" role="button"
                 onclick="goToNovel('${novel.id}')"
                 onmouseover="this.classList.add('bg-body-secondary')"
                 onmouseout="this.classList.remove('bg-body-secondary')">
              <span class="badge ${badgeCls} rounded-circle d-flex align-items-center justify-content-center"
                    style="width:26px;height:26px;flex-shrink:0;font-size:.75rem">${rank + 1}</span>
              <div class="overflow-hidden flex-grow-1">
                <div class="fw-semibold small text-truncate">${esc(novel.book_name)}</div>
                <div class="text-muted d-flex align-items-center gap-1" style="font-size:.7rem">
                  <span class="material-symbols-outlined" style="font-size:12px">visibility</span>
                  ${fmtNum(novel.read || 0)} reads
                </div>
              </div>
            </div>
            ${rank < books.length - 1 ? '<hr class="my-1">' : ''}`;
        }).join('');

    grid.insertAdjacentHTML('beforeend', `
      <div class="col-md-6 col-xl-4">
        <div class="card h-100 shadow-sm">
          <div class="card-header d-flex align-items-center py-3">
            <span class="fw-bold">
              <span class="material-symbols-outlined align-middle text-primary me-1" style="font-size:18px">menu_book</span>
              ${esc(genre)}
            </span>
          </div>
          <div class="card-body py-2 px-3">${booksHtml}</div>
          <div class="card-footer text-end">
            <a href="index.html" class="btn btn-outline-primary btn-sm">
              View all
              <span class="material-symbols-outlined align-middle" style="font-size:14px">arrow_forward</span>
            </a>
          </div>
        </div>
      </div>`);
  });
}

function goToNovel(id) { window.location.href = `novel.html?id=${id}`; }

function fmtNum(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
  if (n >= 1_000)     return (n / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
  return String(n);
}

function esc(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-bs-theme') === 'dark';
  html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
  document.getElementById('themeIcon').textContent = isDark ? 'dark_mode' : 'light_mode';
  localStorage.setItem('nn-theme', isDark ? 'light' : 'dark');
}

function restoreTheme() {
  const saved = localStorage.getItem('nn-theme');
  if (saved) {
    document.documentElement.setAttribute('data-bs-theme', saved);
    const icon = document.getElementById('themeIcon');
    if (icon) icon.textContent = saved === 'dark' ? 'light_mode' : 'dark_mode';
  }
}
</script>
</body>
</html>