<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Discover Novels | WebNovel_Nexus</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>

  <style>
    /* â”€â”€ 1. CSS variables for theming (Bootstrap can't do custom brand colors in dark mode) â”€â”€ */
    :root {
      --nn-primary: #0d6cf2;
    }

    /* â”€â”€ 2. Glassmorphism navbar (Bootstrap has no backdrop-filter support) â”€â”€ */
    /* Higher specificity (nav + class) beats Bootstrap's .navbar without !important */
    nav.nn-navbar {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.85);
    }
    [data-bs-theme="dark"] nav.nn-navbar {
      background: rgba(16, 25, 34, 0.88);
    }

    /* â”€â”€ 3. Card cover image zoom on hover (Bootstrap has no group-hover) â”€â”€ */
    .nn-card .card-img-top {
      transition: transform 0.45s ease;
    }
    .nn-card:hover .card-img-top {
      transform: scale(1.06);
    }
    .nn-card-img-wrap {
      aspect-ratio: 2 / 3;
      overflow: hidden;
    }
    .nn-card-img-wrap img,
    .nn-card-img-wrap .nn-no-cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* â”€â”€ 4. Skeleton shimmer animation (Bootstrap placeholder has no shimmer) â”€â”€ */
    .nn-shimmer {
      background: linear-gradient(90deg,
        var(--bs-secondary-bg) 25%,
        var(--bs-tertiary-bg) 50%,
        var(--bs-secondary-bg) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
    }
    @keyframes shimmer {
      from { background-position: 200% 0; }
      to   { background-position: -200% 0; }
    }
    .nn-skeleton-img {
      aspect-ratio: 2 / 3;
    }

    /* â”€â”€ 5. Line-clamp (not in Bootstrap utilities) â”€â”€ */
    .nn-line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAVBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="nn-navbar navbar navbar-expand-md sticky-top border-bottom shadow-sm">
  <div class="container-xl">
    <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="homepage.html">
      <span class="bg-primary text-white rounded-2 p-1 d-inline-flex align-items-center">
        <span class="material-symbols-outlined" style="font-size:20px">book_4</span>
      </span>
      WebNovel_Nexus
    </a>

    <button class="navbar-toggler" type="button"
      data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto gap-md-1 mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link active fw-semibold" href="index.html">
            <span class="material-symbols-outlined align-middle" style="font-size:16px">explore</span>
            Discover
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="add.html">
            <span class="material-symbols-outlined align-middle" style="font-size:16px">add_circle</span>
            Add Novel
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="booklist.html">
            <span class="material-symbols-outlined align-middle" style="font-size:16px">bookmarks</span>
            My Booklist
          </a>
        </li>
      </ul>
      <div class="d-flex gap-2 align-items-center mt-2 mt-md-0">
        <button class="btn btn-sm btn-outline-secondary" id="themeToggle" title="Toggle theme">
          <span class="material-symbols-outlined align-middle" style="font-size:18px" id="themeIcon">dark_mode</span>
        </button>
        <button class="btn btn-sm btn-outline-secondary">
          <span class="material-symbols-outlined align-middle" style="font-size:18px">notifications</span>
        </button>
        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1">
          <span class="material-symbols-outlined align-middle" style="font-size:18px">account_circle</span>
          My Profile
        </button>
      </div>
    </div>
  </div>
</nav>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="container-xl py-4 py-md-5">
  <div class="row g-4 align-items-start">

    <!-- â”€â”€ Sidebar â”€â”€ -->
    <aside class="col-lg-3">
      <div class="sticky-top" style="top:76px">

        <!-- Search -->
        <div class="input-group mb-4">
          <span class="input-group-text">
            <span class="material-symbols-outlined" style="font-size:18px">search</span>
          </span>
          <input id="searchInput" type="text" class="form-control"
            placeholder="Search novelsâ€¦" autocomplete="off"/>
        </div>

        <!-- Include Tags -->
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center gap-1 py-2">
            <span class="material-symbols-outlined text-success" style="font-size:16px">add_circle</span>
            <span class="fw-bold small text-success">Include Tags</span>
          </div>
          <div class="card-body py-3">
            <div class="d-flex flex-wrap gap-1" id="includeTags"></div>
          </div>
        </div>

        <!-- Exclude Tags -->
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center gap-1 py-2">
            <span class="material-symbols-outlined text-danger" style="font-size:16px">remove_circle</span>
            <span class="fw-bold small text-danger">Exclude Tags</span>
          </div>
          <div class="card-body py-3">
            <div class="d-flex flex-wrap gap-1" id="excludeTags"></div>
          </div>
        </div>

        <!-- Active Filters -->
        <div class="card border-primary d-none" id="activeFiltersWrap">
          <div class="card-header d-flex align-items-center gap-1 py-2">
            <span class="material-symbols-outlined text-primary" style="font-size:16px">filter_list</span>
            <span class="fw-bold small text-primary">Active Filters</span>
          </div>
          <div class="card-body py-3">
            <div class="d-flex flex-wrap gap-1 mb-2" id="activeFiltersList"></div>
            <button id="clearFilters" class="btn btn-outline-secondary btn-sm w-100">
              Clear All Filters
            </button>
          </div>
        </div>

      </div>
    </aside>

    <!-- â”€â”€ Content â”€â”€ -->
    <div class="col-lg-9">

      <!-- Toolbar -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted" id="resultsInfo">Loading novelsâ€¦</small>
        <div class="d-flex align-items-center gap-2">
          <label class="small text-muted mb-0" for="limitSelect">Per page:</label>
          <select id="limitSelect" class="form-select form-select-sm" style="width:80px">
            <option value="12">12</option>
            <option value="20" selected>20</option>
            <option value="40">40</option>
          </select>
        </div>
      </div>

      <!-- Grid -->
      <div class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4 mb-4" id="novelGrid"></div>

      <!-- Pagination -->
      <nav aria-label="Novel pages" class="d-flex justify-content-center">
        <ul class="pagination flex-wrap" id="pagination"></ul>
      </nav>

    </div>
  </div>
</main>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- FOOTER -->
<footer class="border-top bg-body-tertiary mt-5 py-4">
  <div class="container-xl text-center">
    <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
      <span class="bg-primary bg-opacity-25 text-primary rounded p-1 d-inline-flex">
        <span class="material-symbols-outlined" style="font-size:18px">book_4</span>
      </span>
      <span class="fw-bold">WebNovel Nexus</span>
    </div>
    <p class="text-muted small mb-3">Explore thousands of worlds, one chapter at a time.</p>
    <p class="text-muted" style="font-size:.75rem">Created by Danyan Gu and Xing Zhou</p>
  </div>
</footer>

<!-- Toast container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API_BASE = '/api';

const ALL_INCLUDE_TAGS = [
  'Fantasy', 'Sci-Fi', 'Romance', 'Mystery', 'Horror', 'Action',
  'LitRPG', 'Xianxia', 'Cultivation', 'Progression', 'Historical',
  'Dungeon Core', 'System', 'Reincarnation',
];
const ALL_EXCLUDE_TAGS = [
  'Tragedy', 'Dark Fantasy', 'Harem', 'Gore', 'Slow Burn', 'NTR',
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const state = {
  search:      '',
  includeTags: new Set(),
  excludeTags: new Set(),
  page:        1,
  limit:       20,
  total:       0,
  totalPages:  0,
  loading:     false,
};
let searchTimer = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
  restoreTheme();
  buildTagUI();
  bindEvents();
  fetchNovels();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAG UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildTagUI() {
  ALL_INCLUDE_TAGS.forEach(tag => {
    const btn = makeTagBtn(tag, () => toggleIncludeTag(btn, tag));
    document.getElementById('includeTags').appendChild(btn);
  });
  ALL_EXCLUDE_TAGS.forEach(tag => {
    const btn = makeTagBtn(tag, () => toggleExcludeTag(btn, tag));
    document.getElementById('excludeTags').appendChild(btn);
  });
}

function makeTagBtn(label, onClick) {
  const btn = document.createElement('button');
  btn.className = 'btn btn-outline-secondary btn-sm';
  btn.textContent = label;
  btn.dataset.tag = label;
  btn.addEventListener('click', onClick);
  return btn;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bindEvents() {
  document.getElementById('searchInput').addEventListener('input', e => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      state.search = e.target.value.trim();
      state.page = 1;
      updateActiveFiltersSummary();
      fetchNovels();
    }, 400);
  });

  document.getElementById('limitSelect').addEventListener('change', e => {
    state.limit = parseInt(e.target.value);
    state.page = 1;
    fetchNovels();
  });

  document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAG TOGGLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleIncludeTag(btn, tag) {
  // Remove from exclude if there
  if (state.excludeTags.has(tag)) {
    state.excludeTags.delete(tag);
    document.querySelectorAll(`#excludeTags [data-tag="${tag}"]`)
      .forEach(b => { b.className = 'btn btn-outline-secondary btn-sm'; });
  }
  if (state.includeTags.has(tag)) {
    state.includeTags.delete(tag);
    btn.className = 'btn btn-outline-secondary btn-sm';
  } else {
    state.includeTags.add(tag);
    btn.className = 'btn btn-primary btn-sm';
    saveClickedTag(tag);
    showToast(`Tag "${tag}" saved to preferences`, 'success');
  }
  state.page = 1;
  updateActiveFiltersSummary();
  fetchNovels();
}

function toggleExcludeTag(btn, tag) {
  // Remove from include if there
  if (state.includeTags.has(tag)) {
    state.includeTags.delete(tag);
    document.querySelectorAll(`#includeTags [data-tag="${tag}"]`)
      .forEach(b => { b.className = 'btn btn-outline-secondary btn-sm'; });
  }
  if (state.excludeTags.has(tag)) {
    state.excludeTags.delete(tag);
    btn.className = 'btn btn-outline-secondary btn-sm';
  } else {
    state.excludeTags.add(tag);
    btn.className = 'btn btn-danger btn-sm';
  }
  state.page = 1;
  updateActiveFiltersSummary();
  fetchNovels();
}

function saveClickedTag(tag) {
  // Persisted for /api/recommendations Jaccard engine
  const clicked = JSON.parse(localStorage.getItem('clickedTags') || '[]');
  if (!clicked.includes(tag)) {
    clicked.push(tag);
    localStorage.setItem('clickedTags', JSON.stringify(clicked));
  }
}

function clearAllFilters() {
  state.search = ''; state.includeTags.clear(); state.excludeTags.clear(); state.page = 1;
  document.getElementById('searchInput').value = '';
  document.querySelectorAll('#includeTags .btn, #excludeTags .btn')
    .forEach(b => { b.className = 'btn btn-outline-secondary btn-sm'; });
  updateActiveFiltersSummary();
  fetchNovels();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVE FILTERS SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateActiveFiltersSummary() {
  const wrap = document.getElementById('activeFiltersWrap');
  const list = document.getElementById('activeFiltersList');
  const has = state.search || state.includeTags.size || state.excludeTags.size;
  if (!has) { wrap.classList.add('d-none'); return; }
  wrap.classList.remove('d-none');
  list.innerHTML = '';
  if (state.search)
    list.insertAdjacentHTML('beforeend',
      `<span class="badge text-bg-secondary">ğŸ” "${esc(state.search)}"</span>`);
  state.includeTags.forEach(t =>
    list.insertAdjacentHTML('beforeend',
      `<span class="badge text-bg-primary">+${esc(t)}</span>`));
  state.excludeTags.forEach(t =>
    list.insertAdjacentHTML('beforeend',
      `<span class="badge text-bg-danger">âˆ’${esc(t)}</span>`));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FETCH  â€” maps to novelRouter.js:
   GET /api/novels?search=&tags=&exclude=&page=&limit=
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchNovels() {
  if (state.loading) return;
  state.loading = true;
  showSkeletons();

  const params = new URLSearchParams();
  if (state.search)           params.set('search',  state.search);
  if (state.includeTags.size) params.set('tags',    [...state.includeTags].join(','));
  if (state.excludeTags.size) params.set('exclude', [...state.excludeTags].join(','));
  params.set('page',  String(state.page));
  params.set('limit', String(state.limit));

  try {
    const res = await fetch(`${API_BASE}/novels?${params}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();           // { novels, total, page, totalPages }
    state.total      = data.total;
    state.totalPages = data.totalPages;
    renderNovels(data.novels);
    renderPagination();
    updateResultsInfo(data.novels.length, data.total);
  } catch (err) {
    console.error(err);
    renderError();
  } finally {
    state.loading = false;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKELETONS  â€” shimmer via custom CSS class nn-shimmer
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSkeletons() {
  document.getElementById('novelGrid').innerHTML =
    Array.from({ length: 6 }).map(() => `
      <div class="col">
        <div class="card h-100 shadow-sm">
          <div class="nn-shimmer nn-skeleton-img rounded-top"></div>
          <div class="card-body">
            <div class="nn-shimmer rounded mb-2" style="height:15px;width:70%"></div>
            <div class="nn-shimmer rounded mb-3" style="height:11px;width:45%"></div>
            <div class="nn-shimmer rounded mb-2" style="height:10px"></div>
            <div class="nn-shimmer rounded mb-2" style="height:10px;width:85%"></div>
            <div class="nn-shimmer rounded mb-3" style="height:10px;width:60%"></div>
            <div class="nn-shimmer rounded" style="height:34px"></div>
          </div>
        </div>
      </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER NOVELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderNovels(novels) {
  const grid = document.getElementById('novelGrid');
  grid.innerHTML = '';

  if (!novels || novels.length === 0) {
    grid.innerHTML = `
      <div class="col-12 text-center py-5 text-muted">
        <span class="material-symbols-outlined d-block mb-2" style="font-size:48px;opacity:.4">search_off</span>
        <h6 class="fw-bold">No novels found</h6>
        <small>Try adjusting your search or tag filters.</small>
      </div>`;
    return;
  }

  novels.forEach(novel => {
    const id = novel._id;
    const statusCls = {
      Ongoing:   'text-bg-success',
      Completed: 'text-bg-primary',
      Hiatus:    'text-bg-warning',
    }[novel.status] || 'text-bg-secondary';

    const tagsHtml = (novel.tags || [])
      .map(t => `<span class="badge text-bg-primary bg-opacity-75">${esc(t)}</span>`)
      .join(' ');

    const imgContent = novel.coverUrl
      ? `<img src="${esc(novel.coverUrl)}" class="card-img-top" alt="${esc(novel.name)}" loading="lazy"
             onerror="this.parentNode.innerHTML='<div class=&quot;nn-no-cover bg-secondary-subtle d-flex align-items-center justify-content-center&quot;><span class=&quot;material-symbols-outlined text-secondary&quot; style=&quot;font-size:40px&quot;>auto_stories</span></div>'">`
      : `<div class="nn-no-cover bg-secondary-subtle d-flex align-items-center justify-content-center">
           <span class="material-symbols-outlined text-secondary" style="font-size:40px">auto_stories</span>
         </div>`;

    grid.insertAdjacentHTML('beforeend', `
      <div class="col">
        <div class="card h-100 shadow-sm nn-card" role="button" onclick="goToNovel('${id}')">
          <div class="nn-card-img-wrap position-relative">
            ${imgContent}
            <span class="badge ${statusCls} position-absolute top-0 end-0 m-2">
              ${esc(novel.status || 'Ongoing')}
            </span>
          </div>
          <div class="card-body d-flex flex-column">
            <h6 class="card-title fw-bold text-truncate mb-1" title="${esc(novel.name)}">${esc(novel.name)}</h6>
            <p class="text-muted small mb-2">By ${esc(novel.author)}</p>
            ${tagsHtml ? `<div class="d-flex flex-wrap gap-1 mb-2">${tagsHtml}</div>` : ''}
            <p class="card-text small text-muted flex-grow-1 nn-line-clamp-3">
              ${esc(novel.description || '')}
            </p>
            <button class="btn btn-primary btn-sm mt-2 d-flex align-items-center justify-content-center gap-1"
              onclick="event.stopPropagation(); addToBookshelf('${id}', '${esc(novel.name)}')">
              <span class="material-symbols-outlined" style="font-size:16px">library_add</span>
              Add to Bookshelf
            </button>
          </div>
        </div>
      </div>`);
  });
}

function renderError() {
  document.getElementById('novelGrid').innerHTML = `
    <div class="col-12 text-center py-5 text-muted">
      <span class="material-symbols-outlined d-block mb-2" style="font-size:48px;opacity:.4">error</span>
      <h6 class="fw-bold">Failed to load novels</h6>
      <small>Check your connection or server status.</small><br>
      <button onclick="fetchNovels()" class="btn btn-primary btn-sm mt-3">Retry</button>
    </div>`;
  document.getElementById('resultsInfo').textContent = 'Load failed';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGINATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPagination() {
  const ul = document.getElementById('pagination');
  ul.innerHTML = '';
  if (state.totalPages <= 1) return;

  const { page, totalPages } = state;

  ul.insertAdjacentHTML('beforeend', `
    <li class="page-item ${page === 1 ? 'disabled' : ''}">
      <button class="page-link" onclick="goToPage(${page - 1})">â€¹</button>
    </li>`);

  getPageRange(page, totalPages).forEach((p, i, arr) => {
    if (i > 0 && p - arr[i - 1] > 1)
      ul.insertAdjacentHTML('beforeend',
        `<li class="page-item disabled"><span class="page-link">â€¦</span></li>`);
    ul.insertAdjacentHTML('beforeend', `
      <li class="page-item ${p === page ? 'active' : ''}">
        <button class="page-link" onclick="goToPage(${p})">${p}</button>
      </li>`);
  });

  ul.insertAdjacentHTML('beforeend', `
    <li class="page-item ${page === totalPages ? 'disabled' : ''}">
      <button class="page-link" onclick="goToPage(${page + 1})">â€º</button>
    </li>`);
}

function getPageRange(current, total) {
  const delta = 2, range = new Set([1, total]);
  for (let i = Math.max(2, current - delta); i <= Math.min(total - 1, current + delta); i++) range.add(i);
  return [...range].sort((a, b) => a - b);
}

function goToPage(p) {
  if (p < 1 || p > state.totalPages || p === state.page || state.loading) return;
  state.page = p;
  fetchNovels();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS INFO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateResultsInfo(shown, total) {
  const from = total === 0 ? 0 : (state.page - 1) * state.limit + 1;
  const to   = Math.min(state.page * state.limit, total);
  document.getElementById('resultsInfo').textContent =
    total === 0 ? 'No results found'
                : `Showing ${from}â€“${to} of ${total} novel${total !== 1 ? 's' : ''}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goToNovel(id) { window.location.href = `novel.html?id=${id}`; }

function addToBookshelf(id, name) {
  // Visual-only per design spec (Story 6) â€” persisted in localStorage
  const shelf = JSON.parse(localStorage.getItem('bookshelf') || '[]');
  if (!shelf.includes(id)) {
    shelf.push(id);
    localStorage.setItem('bookshelf', JSON.stringify(shelf));
    showToast(`"${name}" added to your bookshelf!`, 'success');
  } else {
    showToast('Already on your bookshelf', 'warning');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME  â€” Bootstrap data-bs-theme + glassmorphism CSS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleTheme() {
  const html  = document.documentElement;
  const isDark = html.getAttribute('data-bs-theme') === 'dark';
  html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
  document.getElementById('themeIcon').textContent = isDark ? 'dark_mode' : 'light_mode';
  localStorage.setItem('nn-theme', isDark ? 'light' : 'dark');
}

function restoreTheme() {
  const saved = localStorage.getItem('nn-theme');
  if (saved) {
    document.documentElement.setAttribute('data-bs-theme', saved);
    const icon = document.getElementById('themeIcon');
    if (icon) icon.textContent = saved === 'dark' ? 'light_mode' : 'dark_mode';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST  â€” Bootstrap native Toast component
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(message, type = 'success') {
  const bg = { success: 'text-bg-success', warning: 'text-bg-warning', danger: 'text-bg-danger' }[type] || 'text-bg-dark';
  const id = `toast-${Date.now()}`;
  document.getElementById('toastContainer').insertAdjacentHTML('beforeend', `
    <div id="${id}" class="toast align-items-center ${bg} border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body fw-semibold">${esc(message)}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`);
  const el = document.getElementById(id);
  new bootstrap.Toast(el, { delay: 3000 }).show();
  el.addEventListener('hidden.bs.toast', () => el.remove());
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
</script>
</body>
</html>